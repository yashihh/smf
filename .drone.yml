kind: pipeline
name: development

steps:
  - name: Check coding style
    pull: never
    image: drone/base:golangci-lint
    depends_on: [ clone ]
    commands:
      - golangci-lint run ./...

  - name: Unit test and build
    pull: never
    image: drone/base:gotest
    depends_on: [ clone ]
    commands:
      - gotestsum ./... -v -cover -race
      - make

  - name: docker_build
    image: plugins/docker
    privileged: true
    depends_on:
      - "Unit test and build"
    settings:
      repo: 10.10.0.50:5000/bitbucket/free5gc/free5gc-smf
      registry: 10.10.0.50:5000
      username:
        from_secret: docker_username
      password:
        from_secret: docker_passwd
      build_args:
        - DEBUG_TOOLS=true
    volumes:
      - name: cert_path
        path: /etc/docker/certs.d/
    when:
      branch:
      - develop

  - name: release
    image: plugins/docker
    depends_on:
      - "Unit test and build"
    privileged: true
    settings:
      force_tag: false
      repo: 10.10.0.50:5000/bitbucket/free5gc/free5gc-smf
      registry: 10.10.0.50:5000
      username:
        from_secret: docker_username
      password:
        from_secret: docker_passwd
      tags:
        - ${DRONE_TAG}
    volumes:
      - name: cert_path
        path: /etc/docker/certs.d/
    when:
      event:
        - tag

volumes:
  - name: cert_path
    host:
      path: /etc/docker/certs.d/


